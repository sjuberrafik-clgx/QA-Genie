# QA On-Demand â€” Flexible workflow for batch/custom pipeline execution
# Supports batch ticket processing and heal-only reruns
name: QA On-Demand

on:
  workflow_dispatch:
    inputs:
      tickets:
        description: 'Comma-separated Jira ticket IDs (e.g., AOTF-123,AOTF-456)'
        required: true
        type: string
      mode:
        description: 'Pipeline mode'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - generate
          - heal
          - execute
      environment:
        description: 'Target environment'
        required: false
        default: 'uat'
        type: choice
        options:
          - uat
          - int
          - prod
      parallel:
        description: 'Max parallel ticket processing'
        required: false
        default: '1'
        type: string
      verbose:
        description: 'Enable verbose logging'
        required: false
        default: false
        type: boolean

permissions:
  contents: read

env:
  NODE_VERSION: '18'
  WORKING_DIR: agentic-workflow

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.split.outputs.matrix }}
      ticket_count: ${{ steps.split.outputs.count }}
    steps:
      - name: Split tickets into matrix
        id: split
        run: |
          TICKETS="${{ github.event.inputs.tickets }}"
          # Convert comma-separated to JSON array
          JSON_ARRAY=$(echo "$TICKETS" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | jq -R . | jq -s .)
          COUNT=$(echo "$JSON_ARRAY" | jq length)
          echo "matrix={\"ticket\":$JSON_ARRAY}" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "Processing $COUNT ticket(s): $TICKETS"

  run-pipeline:
    needs: prepare
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      fail-fast: false
      max-parallel: ${{ fromJSON(github.event.inputs.parallel || '1') }}
      matrix: ${{ fromJSON(needs.prepare.outputs.matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.WORKING_DIR }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci --prefer-offline

      - name: Install Playwright browsers
        working-directory: ${{ env.WORKING_DIR }}
        run: npx playwright install --with-deps chromium

      - name: Run pipeline for ${{ matrix.ticket }}
        working-directory: ${{ env.WORKING_DIR }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COPILOT_MODEL: ${{ vars.COPILOT_MODEL || 'claude-sonnet-4-20250514' }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_CLOUD_ID: ${{ secrets.JIRA_CLOUD_ID }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
          UAT_URL: ${{ secrets.UAT_URL }}
          MCP_HEADLESS: 'true'
          CI: 'true'
        run: |
          VERBOSE_FLAG=""
          if [ "${{ github.event.inputs.verbose }}" = "true" ]; then
            VERBOSE_FLAG="--verbose"
          fi

          node sdk-orchestrator/cli.js \
            --ticket "${{ matrix.ticket }}" \
            --mode "${{ github.event.inputs.mode }}" \
            --ci \
            --env "${{ github.event.inputs.environment }}" \
            $VERBOSE_FLAG

      - name: Upload artifacts for ${{ matrix.ticket }}
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-${{ matrix.ticket }}-${{ github.run_number }}
          path: |
            agentic-workflow/test-artifacts/
            agentic-workflow/test-results/
            agentic-workflow/exploration-data/
            tests/specs/
          retention-days: 14

  summary:
    needs: [prepare, run-pipeline]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ QA On-Demand Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| Tickets | \`${{ github.event.inputs.tickets }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Count | ${{ needs.prepare.outputs.ticket_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Mode | \`${{ github.event.inputs.mode }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ github.event.inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Parallel | ${{ github.event.inputs.parallel }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pipeline Status | ${{ needs.run-pipeline.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Run | [View](/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
